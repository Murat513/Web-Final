<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –∫—É—Ä—Å—ã - Online Courses Platform</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">üéì EduPlatform</a>
            <div class="nav-links">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/courses.html">–ö—É—Ä—Å—ã</a>
                <a href="/dashboard.html" class="active">–ú–æ–∏ –∫—É—Ä—Å—ã</a>
                <a href="/create-course.html">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a>
                <div class="auth-buttons" id="auth-buttons">
                    <button onclick="logout()" class="btn btn-outline">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>–ú–æ–∏ –∫—É—Ä—Å—ã</h1>
            <div class="user-info" id="user-info">
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('enrolled')">–ú–æ–∏ –æ–±—É—á–µ–Ω–∏—è</button>
            <button class="tab-btn" onclick="showTab('created')">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã</button>
            <button class="tab-btn" onclick="showTab('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <div class="tab-content active" id="enrolled-tab">
            <h2>–ö—É—Ä—Å—ã, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∑–∞–ø–∏—Å–∞–Ω—ã</h2>
            <div class="courses-grid" id="my-courses">
                <!-- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <div class="tab-content" id="created-tab">
            <h2>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –≤–∞–º–∏ –∫—É—Ä—Å—ã</h2>
            <div class="courses-grid" id="created-courses">
                <!-- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>

        <div class="tab-content" id="profile-tab">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <div class="profile-card">
                <div class="form-group">
                    <label for="profile-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" id="profile-username">
                </div>
                <div class="form-group">
                    <label for="profile-fullname">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                    <input type="text" id="profile-fullname">
                </div>
                <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email">
                </div>
                <div class="form-group">
                    <label for="profile-bio">–û —Å–µ–±–µ</label>
                    <textarea id="profile-bio" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="profile-role">–†–æ–ª—å</label>
                    <input type="text" id="profile-role" readonly>
                </div>
                <button onclick="saveProfile()" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>

    <script>
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.isAuthenticated) {
                    return data;
                } else {
                    window.location.href = '/login.html';
                    return null;
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
                return null;
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/users/profile', {
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    const user = data.user;
                    
                    document.getElementById('user-info').innerHTML = `
                        <div class="user-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div>
                            <h3>${user.fullName}</h3>
                            <p>${user.role === 'instructor' ? '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å' : '–°—Ç—É–¥–µ–Ω—Ç'}</p>
                        </div>
                    `;
                    
                    document.getElementById('profile-username').value = user.username || '';
                    document.getElementById('profile-fullname').value = user.fullName || '';
                    document.getElementById('profile-email').value = user.email || '';
                    document.getElementById('profile-bio').value = user.bio || '';
                    document.getElementById('profile-role').value = user.role || 'student';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        async function loadMyCourses() {
            try {
                const response = await fetch('/api/enroll/my-courses', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                const coursesGrid = document.getElementById('my-courses');
                
                if (data.success && data.enrollments && data.enrollments.length > 0) {
                    coursesGrid.innerHTML = '';
                    data.enrollments.forEach(item => {
                        const course = item.course;
                        if (!course) return;
                        
                        const courseCard = `
                            <div class="course-card">
                                <div class="course-image">
                                    <img src="${course.thumbnail || 'https://images.unsplash.com/photo-1551650975-87deedd944c3?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" alt="${course.title}">
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${item.progress || 0}%"></div>
                                    </div>
                                </div>
                                <div class="course-content">
                                    <h3>${course.title}</h3>
                                    <p>${course.description?.substring(0, 100) || ''}...</p>
                                    <div class="course-meta">
                                        <span><i class="fas fa-user"></i> ${course.instructor || '–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä'}</span>
                                        <span><i class="fas fa-clock"></i> ${course.duration || 0} —á</span>
                                    </div>
                                    <div class="course-footer">
                                        <div class="progress-info">
                                            <span>–ü—Ä–æ–≥—Ä–µ—Å—Å: ${item.progress || 0}%</span>
                                            <span>–ó–∞–ø–∏—Å–∞–Ω: ${new Date(item.enrolledAt).toLocaleDateString()}</span>
                                        </div>
                                        <div class="course-actions">
                                            <a href="/course.html?id=${course.id}" class="btn btn-sm btn-primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</a>
                                            <button onclick="unenrollFromCourse('${item.enrollmentId}')" class="btn btn-sm btn-danger">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        coursesGrid.innerHTML += courseCard;
                    });
                } else {
                    coursesGrid.innerHTML = '<div class="no-courses"><p>–í—ã –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∏ –Ω–∞ –æ–¥–∏–Ω –∫—É—Ä—Å</p><a href="/courses.html" class="btn btn-primary">–ù–∞–π—Ç–∏ –∫—É—Ä—Å—ã</a></div>';
                }
            } catch (error) {
                console.error('Error loading my courses:', error);
                coursesGrid.innerHTML = '<div class="no-courses"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤</p></div>';
            }
        }

        async function unenrollFromCourse(enrollmentId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è –æ—Ç —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/enroll/${enrollmentId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('–í—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç –∫—É—Ä—Å–∞');
                    await loadMyCourses();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${data.message}`);
                }
            } catch (error) {
                console.error('Error unenrolling from course:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø–∏—Å–∫–µ –æ—Ç –∫—É—Ä—Å–∞');
            }
        }

        async function loadCreatedCourses() {
            try {
                const response = await fetch('/api/enroll/created-courses', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                const coursesGrid = document.getElementById('created-courses');
                
                if (data.success && data.courses && data.courses.length > 0) {
                    coursesGrid.innerHTML = '';
                    data.courses.forEach(course => {
                        const courseCard = `
                            <div class="course-card" id="course-${course.id}">
                                <div class="course-image">
                                    <img src="${course.thumbnail || 'https://images.unsplash.com/photo-1551650975-87deedd944c3?ixlib=rb-4.0.3&auto=format&fit=crop&w=400&q=80'}" alt="${course.title}">
                                </div>
                                <div class="course-content">
                                    <h3>${course.title}</h3>
                                    <p>${course.description?.substring(0, 100) || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}...</p>
                                    <div class="course-meta">
                                        <span><i class="fas fa-clock"></i> ${course.duration || 0} —á</span>
                                        <span><i class="fas fa-users"></i> ${course.studentsEnrolled || 0} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
                                        <span><i class="fas fa-dollar-sign"></i> ${course.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : `$${course.price}`}</span>
                                    </div>
                                    <div class="course-footer">
                                        <div class="course-status">
                                            ${course.isPublished ? 
                                                '<span class="status-published"><i class="fas fa-check-circle"></i> –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</span>' : 
                                                '<span class="status-draft"><i class="fas fa-pencil-alt"></i> –ß–µ—Ä–Ω–æ–≤–∏–∫</span>'
                                            }
                                        </div>
                                        <div class="course-actions">
                                            <a href="/course.html?id=${course.id}" class="btn btn-sm btn-view">
                                                <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                                            </a>
                                            <button onclick="deleteCourse('${course.id}', '${course.title.replace(/'/g, "\\'")}')" class="btn btn-sm btn-delete">
                                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        coursesGrid.innerHTML += courseCard;
                    });
                } else {
                    coursesGrid.innerHTML = '<div class="no-courses"><p>–í—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫—É—Ä—Å–∞</p><a href="/create-course.html" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å</a></div>';
                }
            } catch (error) {
                console.error('Error loading created courses:', error);
                coursesGrid.innerHTML = '<div class="no-courses"><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</p></div>';
            }
        }
        
        async function deleteCourse(courseId, courseTitle) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å "${courseTitle}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                const response = await fetch(`/api/courses/${courseId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const courseElement = document.getElementById(`course-${courseId}`);
                    if (courseElement) {
                        courseElement.style.opacity = '0.5';
                        courseElement.style.pointerEvents = 'none';
                        
                        setTimeout(() => {
                            courseElement.remove();
                            
                            const remainingCourses = document.querySelectorAll('#created-courses .course-card');
                            if (remainingCourses.length === 0) {
                                document.getElementById('created-courses').innerHTML = 
                                    '<div class="no-courses"><p>–ö—É—Ä—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p><a href="/create-course.html" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫—É—Ä—Å</a></div>';
                            }
                        }, 300);
                    }
                    
                    showNotification('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                } else {
                    showNotification(`–û—à–∏–±–∫–∞: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading-indicator');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
        }

        async function saveProfile() {
            try {
                const fullName = document.getElementById('profile-fullname').value;
                const username = document.getElementById('profile-username').value;
                const email = document.getElementById('profile-email').value;
                const bio = document.getElementById('profile-bio').value;
                
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', { fullName, username, email, bio });
                
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        fullName,
                        username,
                        email,
                        bio
                    })
                });
                
                const data = await response.json();
                console.log('üì• –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.success) {
                    alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    await loadUserData();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
            }
        }

        async function loadProfile() {
            await loadUserData();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
                padding: 15px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                z-index: 1000;
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-width: 300px;
                max-width: 400px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        async function init() {
            const authData = await checkAuth();
            if (authData) {
                await loadUserData();
                await loadMyCourses();
                await loadCreatedCourses();
            }
        }

        init();
    </script>

    <style>
        .no-courses {
            text-align: center;
            padding: 3rem;
            background: #f8f9fa;
            border-radius: 10px;
            grid-column: 1 / -1;
        }
        
        .no-courses p {
            margin-bottom: 1rem;
            color: #666;
        }
        
        .progress-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.9rem;
            color: #666;
        }
        
        .course-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</body>
</html>